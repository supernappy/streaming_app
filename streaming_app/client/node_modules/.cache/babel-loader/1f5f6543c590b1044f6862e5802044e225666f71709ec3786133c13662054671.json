{"ast":null,"code":"import React,{useState,useRef,useEffect}from'react';import{useSnackbar}from'notistack';import{Box,Paper,Typography,TextField,IconButton,List,ListItem,ListItemAvatar,Avatar,ListItemText,Chip,Tooltip,Divider,Button,Dialog,DialogTitle,DialogContent,CircularProgress}from'@mui/material';import{Send,Person,Info,Announcement,MusicNote}from'@mui/icons-material';import{useSocket}from'../contexts/SocketContext_enhanced';import{useAuth}from'../contexts/AuthContext';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const RoomChat=_ref=>{var _participants$find;let{room}=_ref;const{enqueueSnackbar}=useSnackbar();const{user}=useAuth();const[message,setMessage]=useState('');const[showRequestDialog,setShowRequestDialog]=useState(false);const[trackSearch,setTrackSearch]=useState('');const[trackResults,setTrackResults]=useState([]);const[isSearching,setIsSearching]=useState(false);const[requestNote,setRequestNote]=useState('');const[selectedTrack,setSelectedTrack]=useState(null);const{messages,sendMessage,participants,reactToMessage,socket,currentRoom,playbackState}=useSocket();// Determine if current user is host\nconst isHost=(_participants$find=participants.find(p=>p.id===user.id))===null||_participants$find===void 0?void 0:_participants$find.isHost;// Host: Accept & Queue song request\nconst handleAcceptSongRequest=msg=>{if(!isHost||!msg.trackId)return;if(socket&&currentRoom){socket.emit('room:add-track',{roomId:currentRoom,trackId:msg.trackId});enqueueSnackbar('Song request accepted and added to queue!',{variant:'success',autoHideDuration:2500});}else{enqueueSnackbar('Failed to accept song request.',{variant:'error',autoHideDuration:2500});}};const messagesEndRef=useRef(null);const messagesContainerRef=useRef(null);useEffect(()=>{scrollToBottom();},[messages]);const scrollToBottom=()=>{var _messagesEndRef$curre;(_messagesEndRef$curre=messagesEndRef.current)===null||_messagesEndRef$curre===void 0?void 0:_messagesEndRef$curre.scrollIntoView({behavior:'smooth'});};const handleSendMessage=e=>{e.preventDefault();if(!message.trim())return;sendMessage(message.trim());setMessage('');enqueueSnackbar('Message sent!',{variant:'info',autoHideDuration:1500});};// Song request logic\nconst handleOpenRequestDialog=()=>{setShowRequestDialog(true);setTrackSearch('');setTrackResults([]);setRequestNote('');setSelectedTrack(null);};const handleCloseRequestDialog=()=>{setShowRequestDialog(false);};const handleTrackSearch=async query=>{setTrackSearch(query);if(!query.trim()){setTrackResults([]);return;}setIsSearching(true);try{const res=await fetch(\"/api/search?q=\".concat(encodeURIComponent(query),\"&type=tracks\"));const data=await res.json();setTrackResults(data.results&&data.results.tracks?data.results.tracks:[]);}catch(err){setTrackResults([]);}finally{setIsSearching(false);}};const handleSelectTrack=track=>{setSelectedTrack(track);};const handleRequestSong=()=>{if(!selectedTrack){enqueueSnackbar('Please select a track to request.',{variant:'warning',autoHideDuration:2000});return;}// Send as a special chat message\nif(socket&&currentRoom){socket.emit('room:chat-message',{roomId:currentRoom,message:requestNote,messageType:'song_request',trackId:selectedTrack.id,trackInfo:{title:selectedTrack.title,artist:selectedTrack.artist,album:selectedTrack.album,genre:selectedTrack.genre,duration:selectedTrack.duration}});enqueueSnackbar('Song request sent!',{variant:'success',autoHideDuration:2000});}else{enqueueSnackbar('Failed to send song request.',{variant:'error',autoHideDuration:2000});}setShowRequestDialog(false);setSelectedTrack(null);setRequestNote('');setTrackSearch('');setTrackResults([]);};const formatTime=timestamp=>{const date=new Date(timestamp);return date.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});};const getMessageTypeIcon=type=>{switch(type){case'system':return/*#__PURE__*/_jsx(Info,{fontSize:\"small\"});case'announcement':return/*#__PURE__*/_jsx(Announcement,{fontSize:\"small\"});default:return/*#__PURE__*/_jsx(Person,{fontSize:\"small\"});}};const getMessageTypeColor=type=>{switch(type){case'system':return'info';case'announcement':return'warning';default:return'default';}};return/*#__PURE__*/_jsxs(Paper,{elevation:6,sx:{height:'100%',display:'flex',flexDirection:'column',background:'rgba(255,255,255,0.15)',backdropFilter:'blur(16px) saturate(180%)',borderRadius:4,boxShadow:'0 8px 32px 0 rgba(31, 38, 135, 0.15)',border:'1px solid rgba(255,255,255,0.18)'},children:[/*#__PURE__*/_jsx(Box,{sx:{p:2,borderBottom:1,borderColor:'divider',display:'flex',alignItems:'center',justifyContent:'space-between',position:'sticky',top:0,zIndex:2,background:'rgba(255,255,255,0.25)',backdropFilter:'blur(12px) saturate(180%)',borderTopLeftRadius:16,borderTopRightRadius:16},children:/*#__PURE__*/_jsxs(Box,{children:[/*#__PURE__*/_jsx(Typography,{variant:\"h6\",gutterBottom:true,children:\"Chat\"}),/*#__PURE__*/_jsxs(Box,{sx:{display:'flex',alignItems:'center',gap:1},children:[/*#__PURE__*/_jsx(Chip,{size:\"small\",label:\"\".concat(participants.length,\" participant\").concat(participants.length!==1?'s':''),variant:\"outlined\"}),/*#__PURE__*/_jsx(Chip,{size:\"small\",label:\"\".concat(messages.length,\" message\").concat(messages.length!==1?'s':''),variant:\"outlined\"})]})]})}),/*#__PURE__*/_jsx(Box,{ref:messagesContainerRef,sx:{flexGrow:1,overflow:'auto',maxHeight:'400px',p:1,background:'rgba(255,255,255,0.10)',transition:'background 0.3s',borderRadius:3},children:messages.length===0?/*#__PURE__*/_jsx(Box,{sx:{display:'flex',alignItems:'center',justifyContent:'center',height:'100%',color:'text.secondary'},children:/*#__PURE__*/_jsx(Typography,{variant:\"body2\",children:\"No messages yet. Start the conversation!\"})}):/*#__PURE__*/_jsxs(List,{sx:{p:0},children:[messages.map((msg,index)=>{var _msg$user,_msg$user2,_msg$user3,_msg$user3$username,_msg$user4;const isCurrentUser=((_msg$user=msg.user)===null||_msg$user===void 0?void 0:_msg$user.id)===user.id;const isSystemMessage=msg.type!=='text'&&msg.type!=='song_request';if(msg.type==='song_request'){var _msg$username,_msg$trackInfo,_msg$trackInfo2,_msg$trackInfo3,_msg$trackInfo4;// Song request message UI\nreturn/*#__PURE__*/_jsxs(ListItem,{alignItems:\"flex-start\",sx:{flexDirection:isCurrentUser?'row-reverse':'row',px:1,py:0.5,transition:'background 0.3s',borderRadius:3,mb:1,background:isCurrentUser?'rgba(124,77,255,0.10)':'rgba(243,229,245,0.7)',boxShadow:isCurrentUser?'0 2px 8px 0 rgba(124,77,255,0.10)':'0 2px 8px 0 rgba(124,77,255,0.05)'},children:[/*#__PURE__*/_jsx(ListItemAvatar,{sx:{minWidth:40},children:/*#__PURE__*/_jsx(Tooltip,{title:msg.username,children:/*#__PURE__*/_jsx(Avatar,{sx:{width:36,height:36,bgcolor:'secondary.main',border:msg.isHost?'2px solid #7c4dff':'2px solid #fff',boxShadow:msg.isHost?'0 0 0 2px #7c4dff':'none',transition:'border 0.2s, box-shadow 0.2s'},children:(_msg$username=msg.username)===null||_msg$username===void 0?void 0:_msg$username.charAt(0).toUpperCase()})})}),/*#__PURE__*/_jsxs(Box,{sx:{maxWidth:'70%',ml:isCurrentUser?0:1,mr:isCurrentUser?1:0},children:[/*#__PURE__*/_jsxs(Paper,{elevation:0,sx:{p:1.5,background:'rgba(124,77,255,0.08)',borderLeft:'6px solid #7c4dff',borderRadius:3,boxShadow:'0 1px 4px 0 rgba(124,77,255,0.08)'},children:[/*#__PURE__*/_jsxs(Typography,{variant:\"caption\",color:\"secondary\",fontWeight:\"bold\",children:[msg.username,\" requested a song:\"]}),/*#__PURE__*/_jsx(Typography,{variant:\"subtitle1\",sx:{fontWeight:600},children:((_msg$trackInfo=msg.trackInfo)===null||_msg$trackInfo===void 0?void 0:_msg$trackInfo.title)||'Unknown Title'}),/*#__PURE__*/_jsxs(Typography,{variant:\"body2\",color:\"text.secondary\",children:[((_msg$trackInfo2=msg.trackInfo)===null||_msg$trackInfo2===void 0?void 0:_msg$trackInfo2.artist)||'Unknown Artist',(_msg$trackInfo3=msg.trackInfo)!==null&&_msg$trackInfo3!==void 0&&_msg$trackInfo3.album?\" \\u2022 \".concat(msg.trackInfo.album):'',(_msg$trackInfo4=msg.trackInfo)!==null&&_msg$trackInfo4!==void 0&&_msg$trackInfo4.genre?\" \\u2022 \".concat(msg.trackInfo.genre):'']}),msg.message&&/*#__PURE__*/_jsx(Typography,{variant:\"body2\",sx:{mt:1},children:/*#__PURE__*/_jsxs(\"i\",{children:[\"\\\"\",msg.message,\"\\\"\"]})}),isHost&&/*#__PURE__*/_jsx(Button,{variant:\"contained\",color:\"primary\",size:\"small\",sx:{mt:1,borderRadius:2,boxShadow:'0 2px 8px 0 rgba(124,77,255,0.15)'},onClick:()=>handleAcceptSongRequest(msg),children:\"Accept & Queue\"})]}),/*#__PURE__*/_jsx(Typography,{variant:\"caption\",color:\"text.secondary\",sx:{display:'block',textAlign:isCurrentUser?'right':'left',mt:0.5,px:1},children:formatTime(msg.timestamp)})]})]},msg.id||index);}// Default (text/system) message UI\nreturn/*#__PURE__*/_jsxs(ListItem,{alignItems:\"flex-start\",sx:{flexDirection:isCurrentUser?'row-reverse':'row',px:1,py:0.5},children:[!isSystemMessage&&/*#__PURE__*/_jsx(ListItemAvatar,{sx:{minWidth:40},children:/*#__PURE__*/_jsx(Tooltip,{title:(_msg$user2=msg.user)===null||_msg$user2===void 0?void 0:_msg$user2.username,children:/*#__PURE__*/_jsx(Avatar,{sx:{width:32,height:32},children:(_msg$user3=msg.user)===null||_msg$user3===void 0?void 0:(_msg$user3$username=_msg$user3.username)===null||_msg$user3$username===void 0?void 0:_msg$user3$username.charAt(0).toUpperCase()})})}),/*#__PURE__*/_jsx(Box,{sx:{maxWidth:'70%',ml:isCurrentUser?0:1,mr:isCurrentUser?1:0},children:isSystemMessage?/*#__PURE__*/_jsx(Box,{sx:{display:'flex',alignItems:'center',justifyContent:'center',my:1},children:/*#__PURE__*/_jsx(Chip,{icon:getMessageTypeIcon(msg.type),label:msg.message,size:\"small\",color:getMessageTypeColor(msg.type),variant:\"outlined\"})}):/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsxs(Paper,{elevation:0,sx:{p:1.5,background:isCurrentUser?'linear-gradient(135deg, #7c4dff 0%, #b388ff 100%)':'rgba(255,255,255,0.7)',color:isCurrentUser?'white':'text.primary',borderRadius:3,borderTopRightRadius:isCurrentUser?0.5:3,borderTopLeftRadius:isCurrentUser?3:0.5,boxShadow:isCurrentUser?'0 2px 8px 0 rgba(124,77,255,0.15)':'0 1px 4px 0 rgba(124,77,255,0.05)',transition:'background 0.3s, color 0.3s'},children:[!isCurrentUser&&/*#__PURE__*/_jsx(Typography,{variant:\"caption\",color:isCurrentUser?'primary.contrastText':'primary.main',fontWeight:\"bold\",children:(_msg$user4=msg.user)===null||_msg$user4===void 0?void 0:_msg$user4.username}),/*#__PURE__*/_jsx(Typography,{variant:\"body2\",sx:{wordWrap:'break-word'},children:msg.message}),/*#__PURE__*/_jsxs(Box,{sx:{display:'flex',alignItems:'center',gap:1,mt:1},children:[msg.reactions&&Object.entries(msg.reactions).map(_ref2=>{let[emoji,userIds]=_ref2;return/*#__PURE__*/_jsx(Chip,{label:\"\".concat(emoji,\" \").concat(userIds.length),size:\"small\",color:userIds.includes(user.id)?'primary':'default',onClick:()=>reactToMessage(msg.id,emoji,!userIds.includes(user.id)),sx:{cursor:'pointer',fontSize:18,borderRadius:2,boxShadow:userIds.includes(user.id)?'0 2px 8px 0 rgba(124,77,255,0.15)':'none',transition:'box-shadow 0.2s'}},emoji);}),[\"👍\",\"😂\",\"🔥\",\"🎵\",\"❤️\"].map(emoji=>/*#__PURE__*/_jsx(Button,{size:\"small\",onClick:()=>reactToMessage(msg.id,emoji,true),sx:{minWidth:32,fontSize:18,p:0.5,borderRadius:2,transition:'background 0.2s','&:hover':{background:'rgba(124,77,255,0.08)'}},children:emoji},emoji))]})]}),/*#__PURE__*/_jsx(Typography,{variant:\"caption\",color:\"text.secondary\",sx:{display:'block',textAlign:isCurrentUser?'right':'left',mt:0.5,px:1},children:formatTime(msg.timestamp)})]})})]},msg.id||index);}),/*#__PURE__*/_jsx(\"div\",{ref:messagesEndRef})]})}),/*#__PURE__*/_jsx(Divider,{}),/*#__PURE__*/_jsx(Box,{sx:{p:2},children:/*#__PURE__*/_jsx(\"form\",{onSubmit:handleSendMessage,children:/*#__PURE__*/_jsxs(Box,{sx:{display:'flex',gap:1},children:[/*#__PURE__*/_jsx(TextField,{fullWidth:true,size:\"small\",placeholder:\"Type a message...\",value:message,onChange:e=>setMessage(e.target.value),variant:\"outlined\",autoComplete:\"off\",multiline:true,maxRows:3}),/*#__PURE__*/_jsx(Tooltip,{title:\"Send message\",children:/*#__PURE__*/_jsx(\"span\",{children:/*#__PURE__*/_jsx(IconButton,{type:\"submit\",color:\"primary\",disabled:!message.trim(),sx:{alignSelf:'flex-end'},children:/*#__PURE__*/_jsx(Send,{})})})})]})})})]});};export default RoomChat;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}