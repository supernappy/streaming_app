{"ast":null,"code":"// Helper to parse LRC lyrics into [{ time, text }]\nimport React,{useState,useEffect,useRef}from'react';import{Box,Paper,Typography,IconButton,Slider,LinearProgress,Avatar,Chip,Tooltip,Fade,Zoom}from'@mui/material';import{PlayArrow,Pause,SkipNext,SkipPrevious,VolumeUp,VolumeDown,VolumeOff,Shuffle,Repeat,RepeatOne,FavoriteBorder,Favorite,QueueMusic,Equalizer,Close,ExpandMore,ExpandLess}from'@mui/icons-material';import{usePlayer}from'../contexts/PlayerContext';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";function parseLRC(lrc){if(!lrc)return null;const lines=lrc.split(/\\r?\\n/);const result=[];const timeExp=/\\[(\\d{1,2}):(\\d{2})(?:\\.(\\d{1,2}))?\\]/;for(const line of lines){const match=line.match(timeExp);if(match){const min=parseInt(match[1],10);const sec=parseInt(match[2],10);const ms=match[3]?parseInt(match[3].padEnd(2,'0'),10):0;const time=min*60+sec+ms/100;const text=line.replace(timeExp,'').trim();result.push({time,text});}}return result;}function SyncedLyrics(_ref){let{lyrics,currentTime}=_ref;const lrcLines=parseLRC(lyrics);const boxRef=React.useRef(null);// Find current line index\nlet currentIdx=-1;for(let i=0;i<lrcLines.length;i++){if(currentTime>=lrcLines[i].time)currentIdx=i;else break;}// Auto-scroll to current line\nReact.useEffect(()=>{if(boxRef.current&&currentIdx>=0){const el=boxRef.current.querySelector(\"[data-lyric-idx='\".concat(currentIdx,\"']\"));if(el){el.scrollIntoView({behavior:'smooth',block:'center'});}}},[currentIdx]);if(!lyrics){return/*#__PURE__*/_jsx(Box,{sx:{mt:1,width:'100%',maxHeight:180,minHeight:60,display:'flex',alignItems:'center',justifyContent:'center',background:'rgba(255,255,255,0.04)',borderRadius:2,p:2},children:/*#__PURE__*/_jsx(Typography,{variant:\"body2\",sx:{color:'#aaa',fontStyle:'italic'},children:\"No lyrics available for this track.\"})});}if(!lrcLines||!lrcLines.length){// fallback: show as plain text\nreturn/*#__PURE__*/_jsxs(Box,{sx:{mt:1,width:'100%',maxHeight:180,minHeight:60,overflowY:'auto',background:'rgba(255,255,255,0.04)',borderRadius:2,p:2},children:[/*#__PURE__*/_jsx(Typography,{variant:\"caption\",sx:{color:'#4ECDC4',fontWeight:700,mb:0.5},children:\"Lyrics\"}),/*#__PURE__*/_jsx(Typography,{variant:\"body1\",sx:{color:'white',whiteSpace:'pre-line',fontSize:16},children:lyrics})]});}return/*#__PURE__*/_jsxs(Box,{ref:boxRef,sx:{mt:1,width:'100%',maxHeight:180,minHeight:60,overflowY:'auto',background:'rgba(255,255,255,0.04)',borderRadius:2,p:2},children:[/*#__PURE__*/_jsx(Typography,{variant:\"caption\",sx:{color:'#4ECDC4',fontWeight:700,mb:0.5},children:\"Lyrics\"}),lrcLines.map((line,idx)=>/*#__PURE__*/_jsx(Typography,{\"data-lyric-idx\":idx,variant:\"body1\",sx:{color:idx===currentIdx?'#1DB954':'white',fontWeight:idx===currentIdx?900:400,background:idx===currentIdx?'rgba(29,185,84,0.12)':'none',borderRadius:1,px:1,py:0.5,fontSize:18,letterSpacing:0.5,transition:'background 0.2s, color 0.2s',mb:0.2},children:line.text},idx))]});}function Player(){var _videoRef$current2,_audioRef$current3;const{currentTrack,isPlaying,volume,currentTime,duration,queue,shuffleMode,repeatMode,isLoading,error,playTrack,togglePlayPause,stop,seek,changeVolume,playNext,playPrevious,toggleShuffle,setRepeat}=usePlayer();// Declare isCurrentTrackMp4 at the very top, before any hooks or logic\nconst isCurrentTrackMp4=currentTrack&&(currentTrack.file_url||currentTrack.url||'').toLowerCase().endsWith('.mp4');// Local state for HTML5 element playback\nconst[html5Playing,setHtml5Playing]=useState(false);// Timer interval for updating localCurrentTime\nuseEffect(()=>{let interval=null;const updateTime=()=>{if(isCurrentTrackMp4&&videoRef.current){setLocalCurrentTime(videoRef.current.currentTime||0);}else if(!isCurrentTrackMp4&&audioRef.current){var _audioRef$current;setLocalCurrentTime(((_audioRef$current=audioRef.current)===null||_audioRef$current===void 0?void 0:_audioRef$current.currentTime)||0);}};if(isCurrentTrackMp4&&videoRef.current&&!videoRef.current.paused||!isCurrentTrackMp4&&audioRef.current&&!audioRef.current.paused){interval=setInterval(updateTime,500);}return()=>{if(interval)clearInterval(interval);};},[isCurrentTrackMp4,currentTrack,html5Playing]);// Show player again when a new track is selected\nuseEffect(()=>{if(currentTrack)setVisible(true);},[currentTrack]);const audioRef=useRef(null);const videoRef=useRef(null);const[localCurrentTime,setLocalCurrentTime]=useState(0);const[localVolume,setLocalVolume]=useState(volume*100);const[isExpanded,setIsExpanded]=useState(true);const[visible,setVisible]=useState(true);// Sync localCurrentTime with global currentTime (for Howler), or HTML5 element (for audio/video)\nuseEffect(()=>{if(isCurrentTrackMp4&&videoRef.current){const handler=()=>{var _videoRef$current;return setLocalCurrentTime(((_videoRef$current=videoRef.current)===null||_videoRef$current===void 0?void 0:_videoRef$current.currentTime)||0);};videoRef.current.addEventListener('timeupdate',handler);return()=>{if(videoRef.current)videoRef.current.removeEventListener('timeupdate',handler);};}else if(!isCurrentTrackMp4&&audioRef.current){const handler=()=>{var _audioRef$current2;return setLocalCurrentTime(((_audioRef$current2=audioRef.current)===null||_audioRef$current2===void 0?void 0:_audioRef$current2.currentTime)||0);};audioRef.current.addEventListener('timeupdate',handler);return()=>{if(audioRef.current)audioRef.current.removeEventListener('timeupdate',handler);};}else{setLocalCurrentTime(currentTime);}},[isCurrentTrackMp4,currentTrack]);useEffect(()=>{setLocalVolume(volume*100);},[volume]);if(!visible||!currentTrack)return null;const handleSeek=(event,newValue)=>{setLocalCurrentTime(newValue);if(isCurrentTrackMp4&&videoRef.current){videoRef.current.currentTime=newValue;}else if(!isCurrentTrackMp4&&audioRef.current){if(audioRef.current)audioRef.current.currentTime=newValue;}else{seek(newValue);}};const handleTogglePlayPause=()=>{if(isCurrentTrackMp4&&videoRef.current){if(videoRef.current.paused){videoRef.current.play();setHtml5Playing(true);}else{videoRef.current.pause();setHtml5Playing(false);}}else if(!isCurrentTrackMp4&&audioRef.current){if(audioRef.current.paused){audioRef.current.play();setHtml5Playing(true);}else{audioRef.current.pause();setHtml5Playing(false);}}else{togglePlayPause();}};const handleVolumeChange=(event,newValue)=>{setLocalVolume(newValue);changeVolume(newValue/100);};const formatTime=time=>{const minutes=Math.floor(time/60);const seconds=Math.floor(time%60);return\"\".concat(minutes,\":\").concat(seconds.toString().padStart(2,'0'));};return/*#__PURE__*/_jsx(Fade,{in:true,children:/*#__PURE__*/_jsx(Paper,{elevation:12,sx:{position:'fixed',left:'50%',bottom:24,transform:'translateX(-50%)',zIndex:1400,width:'95vw',maxWidth:420,borderRadius:4,boxShadow:'0 8px 32px rgba(0,0,0,0.18)',p:{xs:1,sm:2}},children:isCurrentTrackMp4?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"video\",{ref:videoRef,src:currentTrack.file_url||currentTrack.url,poster:currentTrack.cover_url,style:{width:'100%',maxWidth:720,height:'auto',aspectRatio:'16/9',borderRadius:8,background:'#000',marginBottom:8},controls:true,crossOrigin:\"anonymous\",onEnded:playNext,autoPlay:true}),/*#__PURE__*/_jsxs(Box,{sx:{display:'flex',alignItems:'center',width:'100%',mt:1},children:[/*#__PURE__*/_jsx(Avatar,{sx:{width:48,height:48,mr:2,background:'linear-gradient(45deg, #4ECDC4, #44A08D)',fontSize:'1.2rem'},src:currentTrack.cover_url,children:\"\\uD83C\\uDFAC\"}),/*#__PURE__*/_jsxs(Box,{sx:{flex:1,minWidth:0},children:[/*#__PURE__*/_jsx(Typography,{variant:\"subtitle1\",sx:{color:'white',fontWeight:600,textOverflow:'ellipsis',overflow:'hidden',whiteSpace:'nowrap'},children:currentTrack.title||'Unknown Video'}),/*#__PURE__*/_jsx(Typography,{variant:\"caption\",sx:{color:'rgba(255,255,255,0.7)',textOverflow:'ellipsis',overflow:'hidden',whiteSpace:'nowrap'},children:currentTrack.artist||'Unknown Artist'})]}),/*#__PURE__*/_jsx(IconButton,{size:\"small\",onClick:()=>{setVisible(false);stop();},sx:{color:'white',ml:1},children:/*#__PURE__*/_jsx(Close,{fontSize:\"small\"})})]})]}):/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"audio\",{ref:audioRef,src:currentTrack.file_url||currentTrack.url,crossOrigin:\"anonymous\",autoPlay:true,style:{display:'none'},onEnded:playNext}),/*#__PURE__*/_jsxs(Box,{sx:{display:'flex',alignItems:'center',width:'100%'},children:[/*#__PURE__*/_jsx(Avatar,{sx:{width:48,height:48,mr:2,background:'linear-gradient(45deg, #4ECDC4, #44A08D)',fontSize:'1.2rem'},src:currentTrack.cover_url,children:\"\\uD83C\\uDFB5\"}),/*#__PURE__*/_jsxs(Box,{sx:{flex:1,minWidth:0},children:[/*#__PURE__*/_jsx(Typography,{variant:\"subtitle1\",sx:{color:'white',fontWeight:600,textOverflow:'ellipsis',overflow:'hidden',whiteSpace:'nowrap'},children:currentTrack.title||'Unknown Track'}),/*#__PURE__*/_jsx(Typography,{variant:\"caption\",sx:{color:'rgba(255,255,255,0.7)',textOverflow:'ellipsis',overflow:'hidden',whiteSpace:'nowrap'},children:currentTrack.artist||'Unknown Artist'}),/*#__PURE__*/_jsx(Slider,{value:localCurrentTime,max:typeof duration==='number'&&!isNaN(duration)?duration:100,onChange:handleSeek,sx:{color:'#4ECDC4',height:4,mt:0.5,'& .MuiSlider-thumb':{width:12,height:12,backgroundColor:'#4ECDC4'}}}),/*#__PURE__*/_jsxs(Box,{sx:{display:'flex',justifyContent:'space-between',mt:0.5},children:[/*#__PURE__*/_jsx(Typography,{variant:\"caption\",children:formatTime(localCurrentTime)}),/*#__PURE__*/_jsx(Typography,{variant:\"caption\",children:formatTime(duration)})]})]}),/*#__PURE__*/_jsx(IconButton,{size:\"small\",onClick:playPrevious,sx:{color:'white',mx:0.5},children:/*#__PURE__*/_jsx(SkipPrevious,{fontSize:\"small\"})}),/*#__PURE__*/_jsx(IconButton,{size:\"medium\",onClick:handleTogglePlayPause,sx:{color:'white',mx:0.5},children:isCurrentTrackMp4||audioRef.current?(isCurrentTrackMp4?!((_videoRef$current2=videoRef.current)!==null&&_videoRef$current2!==void 0&&_videoRef$current2.paused):!((_audioRef$current3=audioRef.current)!==null&&_audioRef$current3!==void 0&&_audioRef$current3.paused))?/*#__PURE__*/_jsx(Pause,{fontSize:\"medium\"}):/*#__PURE__*/_jsx(PlayArrow,{fontSize:\"medium\"}):isPlaying?/*#__PURE__*/_jsx(Pause,{fontSize:\"medium\"}):/*#__PURE__*/_jsx(PlayArrow,{fontSize:\"medium\"})}),/*#__PURE__*/_jsx(IconButton,{size:\"small\",onClick:playNext,sx:{color:'white',mx:0.5},children:/*#__PURE__*/_jsx(SkipNext,{fontSize:\"small\"})}),/*#__PURE__*/_jsx(IconButton,{size:\"small\",onClick:()=>{setVisible(false);stop();},sx:{color:'white',ml:1},children:/*#__PURE__*/_jsx(Close,{fontSize:\"small\"})})]}),currentTrack.lyrics&&/*#__PURE__*/_jsxs(Box,{sx:{width:'100%',mt:2},children:[/*#__PURE__*/_jsxs(Box,{sx:{display:'flex',alignItems:'center',mb:0.5},children:[/*#__PURE__*/_jsx(Typography,{variant:\"caption\",sx:{color:'#4ECDC4',fontWeight:700,flex:1},children:\"Lyrics\"}),/*#__PURE__*/_jsx(IconButton,{size:\"small\",onClick:()=>setIsExpanded(v=>!v),sx:{color:'#4ECDC4'},children:isExpanded?/*#__PURE__*/_jsx(ExpandMore,{}):/*#__PURE__*/_jsx(ExpandLess,{})})]}),isExpanded&&/*#__PURE__*/_jsx(Box,{sx:{maxHeight:180,minHeight:60,overflowY:'auto',background:'rgba(255,255,255,0.04)',borderRadius:2,p:1,border:'1px solid #4ECDC4'},children:/*#__PURE__*/_jsx(SyncedLyrics,{lyrics:currentTrack.lyrics,currentTime:localCurrentTime})})]}),/*#__PURE__*/_jsxs(Box,{sx:{display:'flex',alignItems:'center',width:'100%',mt:1},children:[/*#__PURE__*/_jsx(VolumeUp,{sx:{mr:1}}),/*#__PURE__*/_jsx(Slider,{value:localVolume,min:0,max:100,onChange:handleVolumeChange,sx:{width:100}}),/*#__PURE__*/_jsxs(Typography,{variant:\"caption\",sx:{ml:1},children:[Math.round(localVolume),\"%\"]})]})]})})});}export default Player;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}